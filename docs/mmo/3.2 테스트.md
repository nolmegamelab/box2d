# 테스트 

dynamic_tree 테스트가 가장 유사하다. 이걸로 하고 오브젝트 이동을 시킨다. 
랜덤 워크로 하고 쿼리가 보이도록 한다. 

여러 쓰레드에서 처리해야 하므로 고려해서 구현한다. 

## dynamic_tree 분석 

Test::MouseDown() 

- 쿼리를 실행 

## sector_tree 테스트 구현 

단일 쓰레드로 먼저 정확한 지 확인하고, 그 다음 멀티쓰레드로 테스트 한다. 

Actor들이 랜덤하게 돌아다니고 프로젝타일이 충돌을 체크하면서 다닌다. 
overlap 된 Actor들은 OBB를 다른 색으로 그려서 확인한다. 

## 그리기와 기본 테스트

액터들 그리기를 하고, 마우스 클릭으로 충돌이 정확하게 되는 지 OBB를 
기준으로 테스트 한다. 


- 섹터 그리드 그리기 

    - Flush()를 해줘야 깜빡 거리지 않는다. 

- 액터 이동 그리기 

    - 정확하게 회전해서 잘 그려져야 한다. 
    - 회전 행렬 계산이 잘못 되었다. 

- 프로젝타일 그리기 

    - m_obb 메모리가 깨지는 현상이 나온다. 
    
        - b2SectorObject에서 m_shape를 delete 
        - collider로 쓸 때 옵션 명시하도록 수정 
    
    - 메모리 누수 문제가 있다. 
    
        - dynamic_tree 테스트도 누수가 있다. 
        - 렌더링 쪽에서 해제 안 하는 메모리가 있는 걸로 보인다. 
        - 별도 테스트를 한번 더 해야겠다. 
        - 이런 거에 당할 수도 있다. 

    - 충돌이 안 되는 경우가 있다. 

        - 위치로 보면 같은 섹터에 있는 두 오브젝트가 충돌이 안 된다. 
        - 아래 마우스 클릭 충돌로 정확성 검증을 한다. 

## 마우스 클릭 충돌 확인 

기능: 

    - 클릭으로 모양에 따라 정확한 테스트를 진행한다. 
    - 단위 테스트를 겸하도록 한다. 
    - Pause 상태에서도 체크 가능하게 한다. 

정확성 검증:

    - 성능은 충분하고도 남는다. 쓰레드 분할 시 괜찮으면 된다. 
    - Circle, OBB, Triangle로 정확하게 체크한다. 
    - Pause 상태에서 Click으로 체크한다. 
    - 이걸로 거의 모든 정확성 체크가 가능하다. 
    - 해당 범위에 들어는 오브젝트들을 찾는 과정을 따라가면 된다. 
        - 정지하고 보면 되므로 디버깅도 어렵지 않다. 
        - proxyId가 m_nodes의 인덱스이기 때문에 더 수월하다.         


box2d의 test_bed에서 좌표계는 그리드들의 중심점이 <0, 0>이 되고, 
왼쪽, 위가 양인 좌표계이다. 


[버그1] DetachProxy에서 DestroyProxy 호출 하지 않던 버그 수정 
[버그2] b2Rot() 기본 생성자가 값을 이상하게 한다. 기본값을 0으로 수정 

dynamic_tree에 뭔가 있긴 한데 AABB가 이상하다. 
[버그3] MoveProxy가 누락되어 생긴 문제였다. 이제 다 잘 된다. 

섹터 경계에서 쿼리를 할 경우 같은 오브젝트가 두 번 포함될 수 있다. 
[버그4] 경계에서 한 오브젝트가 검출될 수 있는 문제
std::set으로 중간에 추출할 때 처리. 


## 멀티 쓰레드 테스트 

정확하게 동작하면 멀티 쓰레드로 만들어 성능을 확인한다. 
지금은 매 프레임 처리하고 있으므로 부하가 높은 상태이다. 

이동을 랜덤하게 초기화 하여 프레임 분산을 하고 
일정한 간격으로 처리할 수 있게 한다. 

완전 부드럽게 잘 동작한다. 

## 충돌 기능 추가 

- 구 충돌 
- 삼각형 충돌 

완전한 테스트가 되려면 프로젝타일의 Shape을 변경하면 좋다. 
OBB 처럼 대규모로 실행하고 pause로 확인한다. 

대신 작업이 더 늘어났다. 항상 바른 선택을 하고 꼼꼼하게 
정리해 두면 나중에 더 큰 이익이 생긴다. 

구는 쉽게 추가되었고, 잘 동작한다. 




## 프로파일링과 최적화 





## 메모리 검증과 최적화 

mimalloc과 같이 외부에서 적용 가능한 라이브러리를 쓴다. 



